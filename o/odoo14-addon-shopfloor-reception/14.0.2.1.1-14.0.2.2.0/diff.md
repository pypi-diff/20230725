# Comparing `tmp/odoo14_addon_shopfloor_reception-14.0.2.1.1-py3-none-any.whl.zip` & `tmp/odoo14_addon_shopfloor_reception-14.0.2.2.0-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,42 +1,42 @@
-Zip file size: 186327 bytes, number of entries: 40
--rw-r--r--  2.0 unx     3384 b- defN 23-Jul-25 10:33 odoo/addons/shopfloor_reception/README.rst
--rw-r--r--  2.0 unx       44 b- defN 23-Jul-25 10:33 odoo/addons/shopfloor_reception/__init__.py
--rw-r--r--  2.0 unx      587 b- defN 23-Jul-25 10:33 odoo/addons/shopfloor_reception/__manifest__.py
--rw-r--r--  2.0 unx      444 b- defN 23-Jul-25 10:33 odoo/addons/shopfloor_reception/data/shopfloor_scenario_data.xml
--rw-r--r--  2.0 unx      627 b- defN 23-Jul-25 10:33 odoo/addons/shopfloor_reception/demo/shopfloor_menu_demo.xml
--rw-r--r--  2.0 unx      965 b- defN 23-Jul-25 10:33 odoo/addons/shopfloor_reception/demo/stock_picking_type_demo.xml
--rw-r--r--  2.0 unx     3866 b- defN 23-Jul-25 10:33 odoo/addons/shopfloor_reception/docs/reception_sequence_graph.mermaid
--rw-r--r--  2.0 unx   155103 b- defN 23-Jul-25 10:33 odoo/addons/shopfloor_reception/docs/reception_sequence_graph.png
--rw-r--r--  2.0 unx     1421 b- defN 23-Jul-25 10:33 odoo/addons/shopfloor_reception/i18n/shopfloor_reception.pot
--rw-r--r--  2.0 unx       28 b- defN 23-Jul-25 10:33 odoo/addons/shopfloor_reception/models/__init__.py
--rw-r--r--  2.0 unx      239 b- defN 23-Jul-25 10:33 odoo/addons/shopfloor_reception/models/stock_picking.py
--rw-r--r--  2.0 unx      216 b- defN 23-Jul-25 10:33 odoo/addons/shopfloor_reception/readme/CONTRIBUTORS.rst
--rw-r--r--  2.0 unx      131 b- defN 23-Jul-25 10:33 odoo/addons/shopfloor_reception/readme/DESCRIPTION.rst
--rw-r--r--  2.0 unx      109 b- defN 23-Jul-25 10:33 odoo/addons/shopfloor_reception/readme/ROADMAP.rst
--rw-r--r--  2.0 unx       24 b- defN 23-Jul-25 10:33 odoo/addons/shopfloor_reception/services/__init__.py
--rw-r--r--  2.0 unx    68055 b- defN 23-Jul-25 10:33 odoo/addons/shopfloor_reception/services/reception.py
--rw-r--r--  2.0 unx     9455 b- defN 23-Jul-25 10:33 odoo/addons/shopfloor_reception/static/description/icon.png
--rw-r--r--  2.0 unx    12973 b- defN 23-Jul-25 10:33 odoo/addons/shopfloor_reception/static/description/index.html
--rw-r--r--  2.0 unx      524 b- defN 23-Jul-25 10:33 odoo/addons/shopfloor_reception/tests/__init__.py
--rw-r--r--  2.0 unx     4853 b- defN 23-Jul-25 10:33 odoo/addons/shopfloor_reception/tests/common.py
--rw-r--r--  2.0 unx     4777 b- defN 23-Jul-25 10:33 odoo/addons/shopfloor_reception/tests/reception_return_common.py
--rw-r--r--  2.0 unx     1253 b- defN 23-Jul-25 10:33 odoo/addons/shopfloor_reception/tests/test_manual_selection.py
--rw-r--r--  2.0 unx     3426 b- defN 23-Jul-25 10:33 odoo/addons/shopfloor_reception/tests/test_reception_done.py
--rw-r--r--  2.0 unx     5282 b- defN 23-Jul-25 10:33 odoo/addons/shopfloor_reception/tests/test_return_reception_done.py
--rw-r--r--  2.0 unx     3587 b- defN 23-Jul-25 10:33 odoo/addons/shopfloor_reception/tests/test_return_scan_document.py
--rw-r--r--  2.0 unx     3889 b- defN 23-Jul-25 10:33 odoo/addons/shopfloor_reception/tests/test_return_scan_line.py
--rw-r--r--  2.0 unx     4524 b- defN 23-Jul-25 10:33 odoo/addons/shopfloor_reception/tests/test_return_set_quantity.py
--rw-r--r--  2.0 unx     4796 b- defN 23-Jul-25 10:33 odoo/addons/shopfloor_reception/tests/test_select_dest_package.py
--rw-r--r--  2.0 unx     6050 b- defN 23-Jul-25 10:33 odoo/addons/shopfloor_reception/tests/test_select_document.py
--rw-r--r--  2.0 unx    10462 b- defN 23-Jul-25 10:33 odoo/addons/shopfloor_reception/tests/test_select_move.py
--rw-r--r--  2.0 unx     6005 b- defN 23-Jul-25 10:33 odoo/addons/shopfloor_reception/tests/test_set_destination.py
--rw-r--r--  2.0 unx     5574 b- defN 23-Jul-25 10:33 odoo/addons/shopfloor_reception/tests/test_set_lot.py
--rw-r--r--  2.0 unx     2267 b- defN 23-Jul-25 10:33 odoo/addons/shopfloor_reception/tests/test_set_lot_confirm.py
--rw-r--r--  2.0 unx    14074 b- defN 23-Jul-25 10:33 odoo/addons/shopfloor_reception/tests/test_set_quantity.py
--rw-r--r--  2.0 unx     2914 b- defN 23-Jul-25 10:33 odoo/addons/shopfloor_reception/tests/test_set_quantity_action.py
--rw-r--r--  2.0 unx     1699 b- defN 23-Jul-25 10:33 odoo/addons/shopfloor_reception/tests/test_start.py
--rw-r--r--  2.0 unx     4006 b- defN 23-Jul-25 10:33 odoo14_addon_shopfloor_reception-14.0.2.1.1.dist-info/METADATA
--rw-r--r--  2.0 unx       92 b- defN 23-Jul-25 10:33 odoo14_addon_shopfloor_reception-14.0.2.1.1.dist-info/WHEEL
--rw-r--r--  2.0 unx        5 b- defN 23-Jul-25 10:33 odoo14_addon_shopfloor_reception-14.0.2.1.1.dist-info/top_level.txt
--rw-rw-r--  2.0 unx     4537 b- defN 23-Jul-25 10:33 odoo14_addon_shopfloor_reception-14.0.2.1.1.dist-info/RECORD
-40 files, 352267 bytes uncompressed, 178615 bytes compressed:  49.3%
+Zip file size: 188272 bytes, number of entries: 40
+-rw-r--r--  2.0 unx     3384 b- defN 23-Jul-25 14:08 odoo/addons/shopfloor_reception/README.rst
+-rw-r--r--  2.0 unx       44 b- defN 23-Jul-25 14:08 odoo/addons/shopfloor_reception/__init__.py
+-rw-r--r--  2.0 unx      587 b- defN 23-Jul-25 14:08 odoo/addons/shopfloor_reception/__manifest__.py
+-rw-r--r--  2.0 unx      444 b- defN 23-Jul-25 14:08 odoo/addons/shopfloor_reception/data/shopfloor_scenario_data.xml
+-rw-r--r--  2.0 unx      627 b- defN 23-Jul-25 14:08 odoo/addons/shopfloor_reception/demo/shopfloor_menu_demo.xml
+-rw-r--r--  2.0 unx      965 b- defN 23-Jul-25 14:08 odoo/addons/shopfloor_reception/demo/stock_picking_type_demo.xml
+-rw-r--r--  2.0 unx     3866 b- defN 23-Jul-25 14:08 odoo/addons/shopfloor_reception/docs/reception_sequence_graph.mermaid
+-rw-r--r--  2.0 unx   155103 b- defN 23-Jul-25 14:08 odoo/addons/shopfloor_reception/docs/reception_sequence_graph.png
+-rw-r--r--  2.0 unx     1421 b- defN 23-Jul-25 14:08 odoo/addons/shopfloor_reception/i18n/shopfloor_reception.pot
+-rw-r--r--  2.0 unx       28 b- defN 23-Jul-25 14:08 odoo/addons/shopfloor_reception/models/__init__.py
+-rw-r--r--  2.0 unx      239 b- defN 23-Jul-25 14:08 odoo/addons/shopfloor_reception/models/stock_picking.py
+-rw-r--r--  2.0 unx      216 b- defN 23-Jul-25 14:08 odoo/addons/shopfloor_reception/readme/CONTRIBUTORS.rst
+-rw-r--r--  2.0 unx      131 b- defN 23-Jul-25 14:08 odoo/addons/shopfloor_reception/readme/DESCRIPTION.rst
+-rw-r--r--  2.0 unx      109 b- defN 23-Jul-25 14:08 odoo/addons/shopfloor_reception/readme/ROADMAP.rst
+-rw-r--r--  2.0 unx       24 b- defN 23-Jul-25 14:08 odoo/addons/shopfloor_reception/services/__init__.py
+-rw-r--r--  2.0 unx    69508 b- defN 23-Jul-25 14:08 odoo/addons/shopfloor_reception/services/reception.py
+-rw-r--r--  2.0 unx     9455 b- defN 23-Jul-25 14:08 odoo/addons/shopfloor_reception/static/description/icon.png
+-rw-r--r--  2.0 unx    12973 b- defN 23-Jul-25 14:08 odoo/addons/shopfloor_reception/static/description/index.html
+-rw-r--r--  2.0 unx      524 b- defN 23-Jul-25 14:08 odoo/addons/shopfloor_reception/tests/__init__.py
+-rw-r--r--  2.0 unx     4853 b- defN 23-Jul-25 14:08 odoo/addons/shopfloor_reception/tests/common.py
+-rw-r--r--  2.0 unx     4777 b- defN 23-Jul-25 14:08 odoo/addons/shopfloor_reception/tests/reception_return_common.py
+-rw-r--r--  2.0 unx     1253 b- defN 23-Jul-25 14:08 odoo/addons/shopfloor_reception/tests/test_manual_selection.py
+-rw-r--r--  2.0 unx     3426 b- defN 23-Jul-25 14:08 odoo/addons/shopfloor_reception/tests/test_reception_done.py
+-rw-r--r--  2.0 unx     5282 b- defN 23-Jul-25 14:08 odoo/addons/shopfloor_reception/tests/test_return_reception_done.py
+-rw-r--r--  2.0 unx     3587 b- defN 23-Jul-25 14:08 odoo/addons/shopfloor_reception/tests/test_return_scan_document.py
+-rw-r--r--  2.0 unx     3889 b- defN 23-Jul-25 14:08 odoo/addons/shopfloor_reception/tests/test_return_scan_line.py
+-rw-r--r--  2.0 unx     4524 b- defN 23-Jul-25 14:08 odoo/addons/shopfloor_reception/tests/test_return_set_quantity.py
+-rw-r--r--  2.0 unx     4796 b- defN 23-Jul-25 14:08 odoo/addons/shopfloor_reception/tests/test_select_dest_package.py
+-rw-r--r--  2.0 unx     6050 b- defN 23-Jul-25 14:08 odoo/addons/shopfloor_reception/tests/test_select_document.py
+-rw-r--r--  2.0 unx    10462 b- defN 23-Jul-25 14:08 odoo/addons/shopfloor_reception/tests/test_select_move.py
+-rw-r--r--  2.0 unx     6005 b- defN 23-Jul-25 14:08 odoo/addons/shopfloor_reception/tests/test_set_destination.py
+-rw-r--r--  2.0 unx     5574 b- defN 23-Jul-25 14:08 odoo/addons/shopfloor_reception/tests/test_set_lot.py
+-rw-r--r--  2.0 unx     2267 b- defN 23-Jul-25 14:08 odoo/addons/shopfloor_reception/tests/test_set_lot_confirm.py
+-rw-r--r--  2.0 unx    22462 b- defN 23-Jul-25 14:08 odoo/addons/shopfloor_reception/tests/test_set_quantity.py
+-rw-r--r--  2.0 unx     2914 b- defN 23-Jul-25 14:08 odoo/addons/shopfloor_reception/tests/test_set_quantity_action.py
+-rw-r--r--  2.0 unx     1699 b- defN 23-Jul-25 14:08 odoo/addons/shopfloor_reception/tests/test_start.py
+-rw-r--r--  2.0 unx     4006 b- defN 23-Jul-25 14:08 odoo14_addon_shopfloor_reception-14.0.2.2.0.dist-info/METADATA
+-rw-r--r--  2.0 unx       92 b- defN 23-Jul-25 14:08 odoo14_addon_shopfloor_reception-14.0.2.2.0.dist-info/WHEEL
+-rw-r--r--  2.0 unx        5 b- defN 23-Jul-25 14:08 odoo14_addon_shopfloor_reception-14.0.2.2.0.dist-info/top_level.txt
+-rw-rw-r--  2.0 unx     4537 b- defN 23-Jul-25 14:08 odoo14_addon_shopfloor_reception-14.0.2.2.0.dist-info/RECORD
+40 files, 362108 bytes uncompressed, 180560 bytes compressed:  50.1%
```

## zipnote {}

```diff
@@ -102,20 +102,20 @@
 
 Filename: odoo/addons/shopfloor_reception/tests/test_set_quantity_action.py
 Comment: 
 
 Filename: odoo/addons/shopfloor_reception/tests/test_start.py
 Comment: 
 
-Filename: odoo14_addon_shopfloor_reception-14.0.2.1.1.dist-info/METADATA
+Filename: odoo14_addon_shopfloor_reception-14.0.2.2.0.dist-info/METADATA
 Comment: 
 
-Filename: odoo14_addon_shopfloor_reception-14.0.2.1.1.dist-info/WHEEL
+Filename: odoo14_addon_shopfloor_reception-14.0.2.2.0.dist-info/WHEEL
 Comment: 
 
-Filename: odoo14_addon_shopfloor_reception-14.0.2.1.1.dist-info/top_level.txt
+Filename: odoo14_addon_shopfloor_reception-14.0.2.2.0.dist-info/top_level.txt
 Comment: 
 
-Filename: odoo14_addon_shopfloor_reception-14.0.2.1.1.dist-info/RECORD
+Filename: odoo14_addon_shopfloor_reception-14.0.2.2.0.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## odoo/addons/shopfloor_reception/__manifest__.py

```diff
@@ -1,11 +1,11 @@
 {
     "name": "Shopfloor Reception",
     "summary": "Reception scenario for shopfloor",
-    "version": "14.0.2.1.1",
+    "version": "14.0.2.2.0",
     "development_status": "Beta",
     "category": "Inventory",
     "website": "https://github.com/OCA/wms",
     "author": "Camptocamp, Odoo Community Association (OCA)",
     "maintainers": ["mmequignon", "JuMiSanAr"],
     "license": "AGPL-3",
     "installable": True,
```

## odoo/addons/shopfloor_reception/services/reception.py

```diff
@@ -522,40 +522,43 @@
             return self.msg_store.x_not_found_or_already_in_dest_package(message_code)
         line_without_package = any(
             not ml.result_package_id for ml in move.move_line_ids
         )
         if move.product_uom_qty - move.quantity_done < 1 and not line_without_package:
             return self.msg_store.move_already_done()
 
+    def _set_quantity__check_quantity_done(self, selected_line):
+        move = selected_line.move_id
+        max_qty_done = move.product_uom_qty
+        qty_done = sum(move.move_line_ids.mapped("qty_done"))
+        rounding = selected_line.product_uom_id.rounding
+        return float_compare(qty_done, max_qty_done, precision_rounding=rounding)
+
     def _set_quantity__by_product(self, picking, selected_line, product):
         # This is a general rule here. whether the return has been created from
         # shopfloor or not, you cannot return more than what was shipped.
         # Therefore, we cannot use the `is_shopfloor_created` here.
         previous_vals = {
             "qty_done": selected_line.qty_done,
         }
         is_return_line = bool(selected_line.move_id.origin_returned_move_id)
-        max_qty_done = selected_line.move_id.product_uom_qty
         if product.id != selected_line.product_id.id:
             return self._response_for_set_quantity(
                 picking,
                 selected_line,
                 message=self.msg_store.wrong_record(product),
             )
         selected_line.qty_done += 1
         response = self._response_for_set_quantity(picking, selected_line)
         if self.work.menu.allow_return and is_return_line:
             message_type = response.get("message", {}).get("message_type")
             # If we have an error, return it, since this is also true for return lines
             if message_type == "error":
                 return response
-            rounding = selected_line.product_uom_id.rounding
-            compare = float_compare(
-                selected_line.qty_done, max_qty_done, precision_rounding=rounding
-            )
+            compare = self._set_quantity__check_quantity_done(selected_line)
             # We cannot set a qty_done superior to what has initally been sent
             if compare == 1:
                 # If so, reset selected_line to its previous state, and return an error
                 selected_line.write(previous_vals)
                 message = self.msg_store.return_line_invalid_qty()
                 return self._response_for_set_quantity(
                     picking, selected_line, message=message
@@ -566,33 +569,28 @@
         # This is a general rule here. whether the return has been created from
         # shopfloor or not, you cannot return more than what was shipped.
         # Therefore, we cannot use the `is_shopfloor_created` here.
         previous_vals = {
             "qty_done": selected_line.qty_done,
         }
         is_return_line = bool(selected_line.move_id.origin_returned_move_id)
-        max_qty_done = selected_line.move_id.product_uom_qty
         if packaging.product_id.id != selected_line.product_id.id:
             return self._response_for_set_quantity(
                 picking,
                 selected_line,
                 message=self.msg_store.wrong_record(packaging),
             )
         selected_line.qty_done += packaging.qty
         response = self._response_for_set_quantity(picking, selected_line)
         if self.work.menu.allow_return and is_return_line:
             message_type = response.get("message", {}).get("message_type")
             # If we have an error, return it, since this is also true for return lines
             if message_type == "error":
                 return response
-            # We cannot set a qty_done superior to what has initally been sent
-            rounding = selected_line.product_uom_id.rounding
-            compare = float_compare(
-                selected_line.qty_done, max_qty_done, precision_rounding=rounding
-            )
+            compare = self._set_quantity__check_quantity_done(selected_line)
             # We cannot set a qty_done superior to what has initally been sent
             if compare == 1:
                 # If so, reset selected_line to its previous state, and return an error
                 selected_line.write(previous_vals)
                 message = self.msg_store.return_line_invalid_qty()
                 return self._response_for_set_quantity(
                     picking, selected_line, message=message
@@ -610,28 +608,19 @@
                 # If the scanned package has a location that isn't a child
                 # of the move dest, return an error
                 message = self.msg_store.dest_location_not_allowed()
                 return self._response_for_set_quantity(
                     picking, selected_line, message=message
                 )
             quantity = selected_line.qty_done
-            __, qty_check = selected_line._split_qty_to_be_done(
-                quantity,
-                lot_id=False,
-                shopfloor_user_id=False,
-                expiration_date=False,
+            response = self._set_quantity__process__set_qty_and_split(
+                picking, selected_line, quantity
             )
-            if qty_check == "greater":
-                return self._response_for_set_quantity(
-                    picking,
-                    selected_line,
-                    message=self.msg_store.unable_to_pick_more(
-                        selected_line.product_uom_qty
-                    ),
-                )
+            if response:
+                return response
             # If the scanned package has a valid destination,
             # set both package and destination on the package.
             selected_line.result_package_id = package
             selected_line.location_dest_id = pack_location
 
             response = self._post_line(selected_line)
             if response:
@@ -744,17 +733,51 @@
             data={
                 "selected_move_line": self._data_for_move_lines(line),
                 "picking": self.data.picking(picking),
             },
             message=message,
         )
 
+    def _align_product_uom_qties(self, move):
+        # This method aligns product uom qties on move lines.
+        # In the shopfloor context, we might have multiple users working at
+        # the same time on the same move. This is done by creating one move line
+        # per user, with shopfloor_user_id = user.
+        # This method ensures that the product_uom_qty reflects what remains to
+        # be done, so we can display coherent numbers on the UI.
+
+        # for a given line, product_uom_qty is computed as this:
+        # remaining_todo = move.product_uom_qty - move.quantity_done
+        # line.product_uom_qty = line.qty_done + remaining_todo
+
+        # However, if the overall qty_done is > to the move's product_uom_qty,
+        # then we're not updating the line's product_uom_qty.
+
+        # TODO, do we need to check move's state?
+        # If move is already done, do not update lines qties
+        # if move.state in ("done", "cancel"):
+        #     return
+
+        qty_todo = move.product_uom_qty
+        qty_done = sum(move.move_line_ids.mapped("qty_done"))
+        rounding = move.product_id.uom_id.rounding
+        compare = float_compare(qty_done, qty_todo, precision_rounding=rounding)
+        if compare < 1:  # If qty done <= qty todo, align qty todo on move lines
+            remaining_todo = qty_todo - qty_done
+            # if we didn't bypass reservation update, the quant reservation
+            # would be reduced as much as the deduced quantity, which is wrong
+            # as we only moved the quantity to a new move line
+            lines = move.move_line_ids.with_context(bypass_reservation_update=True)
+            for line in lines:
+                line.product_uom_qty = line.qty_done + remaining_todo
+
     def _response_for_set_quantity(
         self, picking, line, message=None, asking_confirmation=False
     ):
+        self._align_product_uom_qties(line.move_id)
         return self._response(
             next_state="set_quantity",
             data={
                 "selected_move_line": self._data_for_move_lines(line),
                 "picking": self.data.picking(picking),
                 "confirmation_required": asking_confirmation,
             },
@@ -1087,15 +1110,15 @@
                 picking, selected_line, message=message
             )
         if not selected_line.exists():
             message = self.msg_store.record_not_found()
             return self._response_for_set_quantity(
                 picking, selected_line, message=message
             )
-        if quantity:
+        if quantity is not None:
             # We set qty_done to be equal to the qty of the picker
             # at the moment of the scan.
             response = self._set_quantity__assign_quantity(
                 picking, selected_line, quantity
             )
             if response:
                 return response
@@ -1103,79 +1126,80 @@
             # Then, we add the qty of whatever was scanned
             # on top of the qty of the picker.
             return self._set_quantity__by_barcode(
                 picking, selected_line, barcode, confirmation
             )
         return self._response_for_set_quantity(picking, selected_line)
 
+    def _set_quantity__process__set_qty_and_split(self, picking, line, quantity):
+        move = line.move_id
+        sum(move.move_line_ids.mapped("qty_done"))
+        savepoint = self._actions_for("savepoint").new()
+        line.qty_done = quantity
+        compare = self._set_quantity__check_quantity_done(line)
+        if compare == 1:
+            # If move's qty_done > to move's qty_todo, rollback and return an error
+            savepoint.rollback()
+            return self._response_for_set_quantity(
+                picking, line, message=self.msg_store.unable_to_pick_qty()
+            )
+        savepoint.release()
+        # Only if total_qty_done < qty_todo, we split the move line
+        if compare == -1:
+            default_values = {
+                "lot_id": False,
+                "shopfloor_user_id": False,
+                "expiration_date": False,
+            }
+            line._split_qty_to_be_done(quantity, **default_values)
+
     def process_with_existing_pack(self, picking_id, selected_line_id, quantity):
         picking = self.env["stock.picking"].browse(picking_id)
         selected_line = self.env["stock.move.line"].browse(selected_line_id)
         message = self._check_picking_status(picking)
         if message:
             return self._response_for_set_quantity(
                 picking, selected_line, message=message
             )
-        __, qty_check = selected_line._split_qty_to_be_done(
-            quantity, lot_id=False, shopfloor_user_id=False, expiration_date=False
+        response = self._set_quantity__process__set_qty_and_split(
+            picking, selected_line, quantity
         )
-        if qty_check == "greater":
-            return self._response_for_set_quantity(
-                picking,
-                selected_line,
-                message=self.msg_store.unable_to_pick_more(
-                    selected_line.product_uom_qty
-                ),
-            )
-        selected_line.qty_done = quantity
+        if response:
+            return response
         return self._response_for_select_dest_package(picking, selected_line)
 
     def process_with_new_pack(self, picking_id, selected_line_id, quantity):
         picking = self.env["stock.picking"].browse(picking_id)
         selected_line = self.env["stock.move.line"].browse(selected_line_id)
         message = self._check_picking_status(picking)
         if message:
             return self._response_for_set_quantity(
                 picking, selected_line, message=message
             )
-        __, qty_check = selected_line._split_qty_to_be_done(
-            quantity, lot_id=False, shopfloor_user_id=False, expiration_date=False
+        response = self._set_quantity__process__set_qty_and_split(
+            picking, selected_line, quantity
         )
-        if qty_check == "greater":
-            return self._response_for_set_quantity(
-                picking,
-                selected_line,
-                message=self.msg_store.unable_to_pick_more(
-                    selected_line.product_uom_qty
-                ),
-            )
-        selected_line.qty_done = quantity
+        if response:
+            return response
         picking._put_in_pack(selected_line)
         return self._response_for_set_destination(picking, selected_line)
 
     def process_without_pack(self, picking_id, selected_line_id, quantity):
         picking = self.env["stock.picking"].browse(picking_id)
         selected_line = self.env["stock.move.line"].browse(selected_line_id)
         message = self._check_picking_status(picking)
         if message:
             return self._response_for_set_quantity(
                 picking, selected_line, message=message
             )
-        __, qty_check = selected_line._split_qty_to_be_done(
-            quantity, lot_id=False, shopfloor_user_id=False, expiration_date=False
+        response = self._set_quantity__process__set_qty_and_split(
+            picking, selected_line, quantity
         )
-        if qty_check == "greater":
-            return self._response_for_set_quantity(
-                picking,
-                selected_line,
-                message=self.msg_store.unable_to_pick_more(
-                    selected_line.product_uom_qty
-                ),
-            )
-        selected_line.qty_done = quantity
+        if response:
+            return response
         return self._response_for_set_destination(picking, selected_line)
 
     def _post_line(self, selected_line):
         if (
             selected_line.picking_id.is_shopfloor_created
             and self.work.menu.allow_return
         ):
@@ -1503,21 +1527,21 @@
     def _done_next_states(self):
         return {"select_document", "select_move", "confirm_done"}
 
     def _set_lot_confirm_action_next_states(self):
         return {"set_lot", "set_quantity"}
 
     def _process_with_existing_pack_next_states(self):
-        return {"select_dest_package"}
+        return {"set_quantity", "select_dest_package"}
 
     def _process_with_new_pack_next_states(self):
-        return {"set_destination"}
+        return {"set_quantity", "set_destination"}
 
     def _process_without_pack_next_states(self):
-        return {"set_destination"}
+        return {"set_quantity", "set_destination"}
 
     # SCHEMAS
 
     @property
     def _schema_select_document(self):
         return {
             "pickings": self.schemas._schema_list_of(
```

## odoo/addons/shopfloor_reception/tests/test_set_quantity.py

```diff
@@ -377,7 +377,216 @@
             response,
             next_state="set_destination",
             data={
                 "picking": picking_data,
                 "selected_move_line": self.data.move_lines(selected_move_line),
             },
         )
+
+    @classmethod
+    def _shopfloor_manager_values(cls):
+        vals = super()._shopfloor_manager_values()
+        vals["groups_id"] = [(6, 0, [cls.env.ref("stock.group_stock_user").id])]
+        return vals
+
+    def _get_service_for_user(self, user):
+        user_env = self.env(user=user)
+        return self.get_service(
+            "reception", menu=self.menu, profile=self.profile, env=user_env
+        )
+
+    def test_concurrent_update(self):
+        # We're testing that move line's product uom qties are updated correctly
+        # when users are workng on the same move in parallel
+        picking = self._create_picking()
+        self.service.dispatch("scan_document", params={"barcode": picking.name})
+        self.service.dispatch(
+            "scan_line",
+            params={"picking_id": picking.id, "barcode": self.product_a.barcode},
+        )
+        selected_move_line = picking.move_line_ids.filtered(
+            lambda l: l.product_id == self.product_a
+        )
+        self.assertEqual(len(selected_move_line), 1)
+        self.assertEqual(selected_move_line.qty_done, 1.0)
+
+        # Let's make the first user work a little bit, and pick a total of 4 units
+        for __ in range(4):
+            self.service.dispatch(
+                "set_quantity",
+                params={
+                    "picking_id": picking.id,
+                    "selected_line_id": selected_move_line.id,
+                    "quantity": selected_move_line.qty_done,
+                    "barcode": selected_move_line.product_id.barcode,
+                },
+            )
+        self.assertEqual(selected_move_line.qty_done, 5.0)
+        self.assertEqual(selected_move_line.product_uom_qty, 10.0)
+
+        # Now, concurrently pick products with another user for the same move
+        manager_user = self.shopfloor_manager
+        new_service = self._get_service_for_user(manager_user)
+        new_service.dispatch("scan_document", params={"barcode": picking.name})
+        new_service.dispatch(
+            "scan_line",
+            params={"picking_id": picking.id, "barcode": self.product_a.barcode},
+        )
+        new_line = picking.move_line_ids.filtered(
+            lambda l: l.product_id == self.product_a
+            and l.shopfloor_user_id == manager_user
+        )
+
+        move_lines = selected_move_line | new_line
+        line_service_mapping = [
+            (selected_move_line, self.service),
+            (new_line, new_service),
+        ]
+
+        # Now, we picked 5 for the original line, then 1 for the new one.
+        # Total qty done should be 6
+        lines_qty_done = sum(move_lines.mapped("qty_done"))
+        self.assertEqual(lines_qty_done, 6.0)
+        # should be equal to the moves quantity_done
+        self.assertEqual(lines_qty_done, move_lines.move_id.quantity_done)
+        # And also, the remaining qty is 4.0, then for each move line,
+        # product_uom_qty = line.qty_done + move's remaining_qty
+        for line in move_lines:
+            self.assertEqual(line.product_uom_qty, line.qty_done + 4.0)
+
+        # Now, let the new user finish its work
+        for __ in range(4):
+            new_service.dispatch(
+                "set_quantity",
+                params={
+                    "picking_id": picking.id,
+                    "selected_line_id": new_line.id,
+                    "quantity": new_line.qty_done,
+                    "barcode": new_line.product_id.barcode,
+                },
+            )
+
+        # We should have a qty_done == 10.0 on both moves and move lines
+        lines_qty_done = sum(move_lines.mapped("qty_done"))
+        self.assertEqual(lines_qty_done, 10.0)
+        self.assertEqual(lines_qty_done, move_lines.move_id.quantity_done)
+
+        # And also, the product_uom_qty should be == qty_done == 5.0
+        for line in move_lines:
+            self.assertEqual(line.product_uom_qty, 5.0)
+            self.assertEqual(line.product_uom_qty, line.qty_done)
+
+        # However, if we pick more than move's product_uom_qty, then lines
+        # product_uom_qty isn't updated, in order to be able to display an error
+        # in the frontend
+
+        for __ in range(2):
+            new_service.dispatch(
+                "set_quantity",
+                params={
+                    "picking_id": picking.id,
+                    "selected_line_id": new_line.id,
+                    "quantity": new_line.qty_done,
+                    "barcode": new_line.product_id.barcode,
+                },
+            )
+
+        # We're 2 over move's product_uom_qty
+        lines_qty_done = sum(move_lines.mapped("qty_done"))
+        self.assertEqual(lines_qty_done, 12.0)
+        self.assertEqual(lines_qty_done, move_lines.move_id.quantity_done)
+
+        # We shouldn't be able to process any of those move lines
+        error_msg = {
+            "message_type": "error",
+            "body": "You cannot process that much units.",
+        }
+        picking_data = self.data.picking(picking)
+        for line, service in line_service_mapping:
+            response = service.dispatch(
+                "process_with_new_pack",
+                params={
+                    "picking_id": picking.id,
+                    "selected_line_id": line.id,
+                    "quantity": line.qty_done,
+                },
+            )
+            self.assert_response(
+                response,
+                next_state="set_quantity",
+                data={
+                    "picking": picking_data,
+                    "selected_move_line": self.data.move_lines(line),
+                    "confirmation_required": False,
+                },
+                message=error_msg,
+            )
+
+        # But line's product_uom_qty hasn't changed and is still 10.0
+        self.assertEqual(sum(move_lines.mapped("product_uom_qty")), 10.0)
+
+        # If we lower by 2 the first move qty done, qty_todo will be updated correctly
+        self.service.dispatch(
+            "set_quantity",
+            params={
+                "picking_id": picking.id,
+                "selected_line_id": selected_move_line.id,
+                "quantity": 2.0,
+                "barcode": selected_move_line.product_id.barcode,
+            },
+        )
+
+        self.assertEqual(selected_move_line.qty_done, 3.0)
+        self.assertEqual(selected_move_line.product_uom_qty, 3.0)
+
+        self.assertEqual(new_line.qty_done, 7.0)
+        self.assertEqual(new_line.product_uom_qty, 7.0)
+
+        # And everything's fine on the move
+        move = move_lines.move_id
+        self.assertEqual(move.product_uom_qty, move.quantity_done)
+        self.assertEqual(move.product_uom_qty, 10.0)
+
+    def test_split_move_line(self):
+        picking = self._create_picking()
+        self.service.dispatch("scan_document", params={"barcode": picking.name})
+        self.service.dispatch(
+            "scan_line",
+            params={"picking_id": picking.id, "barcode": self.product_a.barcode},
+        )
+        selected_move_line = picking.move_line_ids.filtered(
+            lambda l: l.product_id == self.product_a
+        )
+        self.assertEqual(len(selected_move_line), 1)
+        self.assertEqual(selected_move_line.qty_done, 1.0)
+        # Now, concurrently pick products with another user for the same move
+        manager_user = self.shopfloor_manager
+        new_service = self._get_service_for_user(manager_user)
+        new_service.dispatch("scan_document", params={"barcode": picking.name})
+        new_service.dispatch(
+            "scan_line",
+            params={"picking_id": picking.id, "barcode": self.product_a.barcode},
+        )
+
+        # Try to process the first line
+        response = self.service.dispatch(
+            "process_with_new_pack",
+            params={
+                "picking_id": picking.id,
+                "selected_line_id": selected_move_line.id,
+                "quantity": 1.0,
+            },
+        )
+        picking_data = self.data.picking(picking)
+        self.assert_response(
+            response,
+            next_state="set_destination",
+            data={
+                "picking": picking_data,
+                "selected_move_line": self.data.move_lines(selected_move_line),
+            },
+        )
+        # there should be 3 lines now
+        move_lines = picking.move_line_ids.filtered(
+            lambda l: l.product_id == self.product_a
+        )
+        self.assertEqual(len(move_lines), 3)
```

## Comparing `odoo14_addon_shopfloor_reception-14.0.2.1.1.dist-info/METADATA` & `odoo14_addon_shopfloor_reception-14.0.2.2.0.dist-info/METADATA`

 * *Files 2% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: odoo14-addon-shopfloor-reception
-Version: 14.0.2.1.1
+Version: 14.0.2.2.0
 Summary: Reception scenario for shopfloor
 Home-page: https://github.com/OCA/wms
 Author: Camptocamp, Odoo Community Association (OCA)
 Author-email: support@odoo-community.org
 License: AGPL-3
 Platform: UNKNOWN
 Classifier: Programming Language :: Python
```

## Comparing `odoo14_addon_shopfloor_reception-14.0.2.1.1.dist-info/RECORD` & `odoo14_addon_shopfloor_reception-14.0.2.2.0.dist-info/RECORD`

 * *Files 3% similar despite different names*

```diff
@@ -1,23 +1,23 @@
 odoo/addons/shopfloor_reception/README.rst,sha256=Tnpc_JsUSx9BfFo1IeKugKcvXhlMwt2Xb3QNxI58nuY,3384
 odoo/addons/shopfloor_reception/__init__.py,sha256=kYJNnKRGQ0n5bRWJIoEPgRN_IzlcYzepihpGRteXVuI,44
-odoo/addons/shopfloor_reception/__manifest__.py,sha256=KXGT01_IzkaKdb8VmZvLbWH82RuQk2m6Ujmo_yPa0R8,587
+odoo/addons/shopfloor_reception/__manifest__.py,sha256=vQzkOVte0K8vEuMtY7TE0t_3u8g0dmpSDzDMEeFlNzs,587
 odoo/addons/shopfloor_reception/data/shopfloor_scenario_data.xml,sha256=1bnPstzVOLobxvI39DOWBYv85Yh16LLvgDnICN7E0n8,444
 odoo/addons/shopfloor_reception/demo/shopfloor_menu_demo.xml,sha256=gNiAE7qk8vWaV2wnol52hOo1fFOM_9mxUyl3vKESspw,627
 odoo/addons/shopfloor_reception/demo/stock_picking_type_demo.xml,sha256=bsT91Ie8Sq1tzRyDlxqRTa3HoNlqRdDQyPLwYHVkDuE,965
 odoo/addons/shopfloor_reception/docs/reception_sequence_graph.mermaid,sha256=RtF-q5XBm9-Bw27MQXt-12oS4bdmTW6FSgyYbr4YXV0,3866
 odoo/addons/shopfloor_reception/docs/reception_sequence_graph.png,sha256=H41YZ5izgSD5CBxoDv51ypNGeWrOlwA7sXNH2NH1guM,155103
 odoo/addons/shopfloor_reception/i18n/shopfloor_reception.pot,sha256=Ug5evnjOpN8Eed2-I0pq-jIa-VzMv9Qz8pKxd24rP3o,1421
 odoo/addons/shopfloor_reception/models/__init__.py,sha256=4KFk_msDhkBW-mEo4xByYxOerTYuVKjeaNN8_WcH6y8,28
 odoo/addons/shopfloor_reception/models/stock_picking.py,sha256=Vmderz3uCz3HTyKB1nJRpFyb-KgeR0P1Hb3PDULI4s0,239
 odoo/addons/shopfloor_reception/readme/CONTRIBUTORS.rst,sha256=T0hVdBlkQoY1jSU4_VeTBpXUfsII9PSBrSh7jtmOe2Y,216
 odoo/addons/shopfloor_reception/readme/DESCRIPTION.rst,sha256=WgVul7wqGircZzFGHZlHdf7uQwGDNYADf9HXF96ngow,131
 odoo/addons/shopfloor_reception/readme/ROADMAP.rst,sha256=-oVCQbD8gOlGbREemrJISQ785Mhf3_KDv4b26EKl0lw,109
 odoo/addons/shopfloor_reception/services/__init__.py,sha256=KwBANbkfhp2yAZYBiuBKYL2G7ky7sCaE-0yO4b-0mgs,24
-odoo/addons/shopfloor_reception/services/reception.py,sha256=WE5BR89gi4wDEK-KUSGiw8f8wi-YANdBFWb4fwR4NFU,68055
+odoo/addons/shopfloor_reception/services/reception.py,sha256=P1vJ8bjEY6pDIkQLZ33YVYEgsRLEk8qiSmIiPvkrWeY,69508
 odoo/addons/shopfloor_reception/static/description/icon.png,sha256=6xBPJauaFOF0KDHfHgQopSc28kKvxMaeoQFQWZtfZDo,9455
 odoo/addons/shopfloor_reception/static/description/index.html,sha256=a5J-vJ6aIA2frc-pJnrak7YlbPL4ksEXYOePLA1-tWg,12973
 odoo/addons/shopfloor_reception/tests/__init__.py,sha256=JSL0WRljl0_Y_4SG0ORN1KFlcdsXBSAQ3y_U34KHE8E,524
 odoo/addons/shopfloor_reception/tests/common.py,sha256=wvv9IbjNpsV18tui2xmh2SknYoQOdKGqTQENDCWzExI,4853
 odoo/addons/shopfloor_reception/tests/reception_return_common.py,sha256=Jwq1fDJFUGt0jOfgMsO2gQl9iof6ToIpE2BVKdPfxFw,4777
 odoo/addons/shopfloor_reception/tests/test_manual_selection.py,sha256=jUWqAyWcGsoFTLeLLOk0mTadZk-mlR1RBbl4fasUoWI,1253
 odoo/addons/shopfloor_reception/tests/test_reception_done.py,sha256=faN4u46BewkA3j01kglpzBkiIEiaO4gKRuhrQ_m_ubg,3426
@@ -27,14 +27,14 @@
 odoo/addons/shopfloor_reception/tests/test_return_set_quantity.py,sha256=Np2SWaR7adks4YPJJ7YAOsQ-Nz2sI2C9iFOzSpfvJm0,4524
 odoo/addons/shopfloor_reception/tests/test_select_dest_package.py,sha256=TL3hb689oB5rtIUiDu8KobN3zyOl47sOaCmhjWrbDRM,4796
 odoo/addons/shopfloor_reception/tests/test_select_document.py,sha256=xVL4NsAVD3feAx3EXV4e60CQkoWWMZzK2PJpPCZenGg,6050
 odoo/addons/shopfloor_reception/tests/test_select_move.py,sha256=_LaXBz7AJtODq12azZxIjtHZYFPHT4euxkG7KFVO9ys,10462
 odoo/addons/shopfloor_reception/tests/test_set_destination.py,sha256=kQaLYX-vV8SjR_BAGLZZZl861dR9AqIFWJ44D1fBMq4,6005
 odoo/addons/shopfloor_reception/tests/test_set_lot.py,sha256=JtEMOcBNYAYmj1KIL9C2Zs4dBJWM7dbwadO3iRi5bOo,5574
 odoo/addons/shopfloor_reception/tests/test_set_lot_confirm.py,sha256=LfC8ct247by9V2Df3THnE_VT4dT0KMYrWGn28JM2lR8,2267
-odoo/addons/shopfloor_reception/tests/test_set_quantity.py,sha256=8sPiRntPeRM8oJfcMDLhWVgphJmPALV18btU5vfZek4,14074
+odoo/addons/shopfloor_reception/tests/test_set_quantity.py,sha256=PniMI-YTy8mpaybohKGuKRvZCf2rqVKgeMacSG6I3bA,22462
 odoo/addons/shopfloor_reception/tests/test_set_quantity_action.py,sha256=Q1AjYwAJT-lVjYPOOi0P-9cyes0wfniSiH0R3lGgvQU,2914
 odoo/addons/shopfloor_reception/tests/test_start.py,sha256=Df9ezNG7BqJQ6PtNY4-LvH1SyFZdpyF4LjV1PhpsCqY,1699
-odoo14_addon_shopfloor_reception-14.0.2.1.1.dist-info/METADATA,sha256=1lKWjuO_YE-jIMqx81660sJ6GmkAEv_nfpdGLiizwYo,4006
-odoo14_addon_shopfloor_reception-14.0.2.1.1.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
-odoo14_addon_shopfloor_reception-14.0.2.1.1.dist-info/top_level.txt,sha256=qBj40grFkGOfDZ2WDSw3y1RnDlgG0u8rP8pvGNdbz4w,5
-odoo14_addon_shopfloor_reception-14.0.2.1.1.dist-info/RECORD,,
+odoo14_addon_shopfloor_reception-14.0.2.2.0.dist-info/METADATA,sha256=_oDM7OLSUgRib1XiJm0snTgCpVc3X8z7gHbFSrtgWtU,4006
+odoo14_addon_shopfloor_reception-14.0.2.2.0.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
+odoo14_addon_shopfloor_reception-14.0.2.2.0.dist-info/top_level.txt,sha256=qBj40grFkGOfDZ2WDSw3y1RnDlgG0u8rP8pvGNdbz4w,5
+odoo14_addon_shopfloor_reception-14.0.2.2.0.dist-info/RECORD,,
```

